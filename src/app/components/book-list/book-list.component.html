<div class="book-list-container">
  <header class="book-list-header">
    <div class="header-content">
      <div class="header-left">
        <h1>Library Catalog</h1>
        <p>Browse and search all available books</p>
      </div>
      <div class="header-right">
        <button *ngIf="canPerformAdminActions()" class="btn btn-primary create-book-btn" (click)="createBook()">
          Create Book
        </button>
      </div>
    </div>
  </header>

  <div class="book-list-content">
    <div class="filters-and-search">
      <div class="filters-section">
        <h3>Filters</h3>

        <div class="filter-group">
          <label for="authorFilter">Author</label>
          <select id="authorFilter" [(ngModel)]="authorFilter" (change)="applyFilters()" class="form-control">
            <option *ngFor="let author of authors" [value]="author.name">{{ author.name }}</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="yearFilter">Publication Year</label>
          <select id="yearFilter" [(ngModel)]="yearFilter" (change)="applyFilters()" class="form-control">
            <option *ngFor="let year of years" [value]="year">{{ year }}</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="availabilityFilter">Availability</label>
          <select id="availabilityFilter" [(ngModel)]="availabilityFilter" (change)="applyFilters()"
            class="form-control">
            <option value="Available">Available Only</option>
            <option value="Unavailable">Unavailable</option>
          </select>
        </div>

        <div class="filter-actions">
          <button class="btn btn-secondary btn-sm" (click)="clearFilters()">Clear Filters</button>
        </div>
      </div>

      <div class="search-and-results">
        <div class="search-section">
          <div class="search-bar">
            <input type="text" [(ngModel)]="searchTerm" (input)="onSearchInputEvent($event)"
              placeholder="Search by title, author, or ISBN..." class="form-control">
          </div>
        </div>

        <div class="books-table-container" *ngIf="books.length > 0; else noResults">
          <table class="books-table">
            <thead>
              <tr>
                <th (click)="sort('title')" class="sortable">
                  Title {{ getSortIcon('title') }}
                </th>
                <th (click)="sort('summary')" class="sortable">
                  Summary {{ getSortIcon('summary') }}
                </th>
                <th (click)="sort('isbn')" class="sortable">
                  ISBN {{ getSortIcon('isbn') }}
                </th>
                <th (click)="sort('published')" class="sortable">
                  Published {{ getSortIcon('published') }}
                </th>
                <th (click)="sort('genre')" class="sortable">
                  Genre {{ getSortIcon('genre') }}
                </th>
                <th (click)="sort('author')" class="sortable">
                  Author {{ getSortIcon('author') }}
                </th>
                <th>Availability</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let book of books">
                <td class="title-cell">{{ book.title }}</td>
                <td class="summary-cell">{{ book.summary }}</td>
                <td class="isbn-cell">{{ book.isbn }}</td>
                <td class="published-cell">{{ book.publishedOn | date:'yyyy-MM-dd' }}</td>
                <td class="genre-cell">{{ book.genre.name }}</td>
                <td class="author-cell">{{ book.author.name }}</td>
                <td class="availability-cell">
                  <span [class]="book.availability ? 'available' : 'unavailable'">
                    {{ book.availability ? 'Available' : 'Unavailable' }}
                  </span>
                </td>
                <td class="actions-cell">
                  <div class="action-buttons">
                    <button class="action-btn borrow-btn" [disabled]="book.availability === 'Unavailable'"
                      (click)="borrowBook(book)" title="Borrow Book">
                      üìö
                    </button>
                    <button class="action-btn view-btn" (click)="viewBook(book)" title="View Book">
                      üëÅÔ∏è
                    </button>
                    <button *ngIf="canPerformAdminActions()" class="action-btn edit-btn" (click)="editBook(book)"
                      title="Edit Book">
                      ‚úèÔ∏è
                    </button>
                    <button *ngIf="canPerformAdminActions()" class="action-btn delete-btn" (click)="deleteBook(book)"
                      title="Delete Book">
                      üóëÔ∏è
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <ng-template #noResults>
          <div class="no-results">
            <div class="no-results-content">
              <h3>No books found</h3>
              <p>No books match your current filters.</p>
              <p>Try adjusting your search criteria or clearing the filters.</p>
            </div>
          </div>
        </ng-template>

        <!-- Pagination -->
        <div class="pagination-container" *ngIf="totalItems > 1">
          <div class="pagination-info">
            Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to {{ getMin(currentPage * itemsPerPage, totalItems) }}
            of {{ totalItems }} books
          </div>
          <div class="pagination">
            <button class="pagination-btn" [disabled]="currentPage === 1" (click)="onPageChange(currentPage - 1)">
              Previous
            </button>

            <button *ngFor="let page of getPageNumbers()" class="pagination-btn" [class.active]="page === currentPage"
              (click)="onPageChange(page)">
              {{ page }}
            </button>

            <button class="pagination-btn" [disabled]="currentPage === totalPages"
              (click)="onPageChange(currentPage + 1)">
              Next
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- View Book Modal -->
<div class="modal-overlay" *ngIf="showViewModal" (click)="closeViewModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Book Details</h3>
      <button class="close-btn" (click)="closeViewModal()">√ó</button>
    </div>
    <div class="modal-body" *ngIf="selectedBook">
      <div class="book-detail">
        <div class="detail-row">
          <label>Title:</label>
          <span>{{ selectedBook.title }}</span>
        </div>
        <div class="detail-row">
          <label>Summary:</label>
          <span>{{ selectedBook.summary }}</span>
        </div>
        <div class="detail-row">
          <label>ISBN:</label>
          <span>{{ selectedBook.isbn }}</span>
        </div>
        <div class="detail-row">
          <label>Published:</label>
          <span>{{ selectedBook.publishedOn }}</span>
        </div>
        <div class="detail-row">
          <label>Total Copies:</label>
          <span>{{ selectedBook.totalCopies }}</span>
        </div>
        <div class="detail-row">
          <label>Genre:</label>
          <span>{{ selectedBook.genre.name }}</span>
        </div>
        <div class="detail-row">
          <label>Author:</label>
          <span>{{ selectedBook.author.name }}</span>
        </div>
        <div class="detail-row">
          <label>Availability:</label>
          <span [class]="selectedBook.availability ? 'available' : 'unavailable'">
            {{ selectedBook.availability ? 'Available' : 'Unavailable' }}
          </span>
        </div>
      </div>
    </div>
    <div class="modal-footer">

      <button class="btn btn-secondary" (click)="closeViewModal()">Close</button>
    </div>
  </div>
</div>

<!-- Create Book Modal -->
<div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Create Book</h3>
      <button class="close-btn" (click)="closeCreateModal()">√ó</button>
    </div>
    <div class="modal-body" *ngIf="newBook">
      <form class="edit-form">
        <div class="form-group">
          <label>Title</label>
          <input type="text" [(ngModel)]="newBook.title" name="title" class="form-control">
        </div>
        <div class="form-group">
          <label>Summary</label>
          <textarea [(ngModel)]="newBook.summary" name="summary" class="form-control" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>ISBN</label>
          <input type="text" [(ngModel)]="newBook.isbn" name="isbn" class="form-control">
        </div>
        <div class="form-group">
          <label>Published Date</label>
          <input type="date" [(ngModel)]="newBook.publishedOn" name="publishedOn" class="form-control">
        </div>
        <div class="form-group">
          <label>Total Copies</label>
          <input type="number" [(ngModel)]="newBook.totalCopies" name="totalCopies" class="form-control" min="1">
        </div>
        <div class="form-group">
          <label>Genre</label>
          <select [(ngModel)]="newBook.genre" name="genre" class="form-control">
            <option *ngFor="let genre of genres" [ngValue]="genre">{{ genre.name }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Author</label>
          <select [(ngModel)]="newBook.author" name="author" class="form-control">
            <option *ngFor="let author of authors" [ngValue]="author">{{ author.name }}</option>
          </select>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeCreateModal()">Cancel</button>
      <button class="btn btn-primary" (click)="createNewBook()">Create</button>
    </div>
  </div>
</div>

<!-- Edit Book Modal -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Edit Book</h3>
      <button class="close-btn" (click)="closeEditModal()">√ó</button>
    </div>
    <div class="modal-body" *ngIf="selectedBook">
      <form class="edit-form">
        <div class="form-group">
          <label>Title</label>
          <input type="text" [(ngModel)]="selectedBook.title" name="title" class="form-control">
        </div>
        <div class="form-group">
          <label>Summary</label>
          <textarea [(ngModel)]="selectedBook.summary" name="summary" class="form-control" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>ISBN</label>
          <input type="text" [(ngModel)]="selectedBook.isbn" name="isbn" class="form-control">
        </div>
        <div class="form-group">
          <label>Published Date</label>
          <input type="date" [(ngModel)]="selectedBookPublishedOn" name="published" class="form-control">
        </div>
        <div class="form-group">
          <label>Total Copies</label>
          <input type="number" [(ngModel)]="selectedBook.totalCopies" name="totalCopies" class="form-control">
        </div>
        <div class="form-group">
          <label>Genre</label>
          <select [(ngModel)]="selectedBook.genre" name="genre" class="form-control">
            <option *ngFor="let genre of genres" [ngValue]="genre">{{ genre.name }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Author</label>
          <select [(ngModel)]="selectedBook.author" name="author" class="form-control">
            <option *ngFor="let author of authors" [ngValue]="author">{{ author.name }}</option>
          </select>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeEditModal()">Cancel</button>
      <button class="btn btn-primary" (click)="updateBook()">Save Changes</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeleteConfirm" (click)="closeDeleteConfirm()">
  <div class="modal delete-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Confirm Delete</h3>
      <button class="close-btn" (click)="closeDeleteConfirm()">√ó</button>
    </div>
    <div class="modal-body" *ngIf="selectedBook">
      <p>Are you sure you want to delete the book <strong>"{{ selectedBook.title }}"</strong> by {{
        selectedBook.author.name
        }}?</p>
      <p class="warning-text">This action cannot be undone.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeDeleteConfirm()">Cancel</button>
      <button class="btn btn-danger" (click)="confirmDelete()">Delete Book</button>
    </div>
  </div>
</div>